name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  build:
    name: Build Frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Create tarball of build
        run: |
          tar -czf dist.tar.gz -C dist .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist.tar.gz
          retention-days: 1
          if-no-files-found: error

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ vars.SERVER_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v5
        with:
          name: frontend-build
          path: .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            dist.tar.gz \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.FRONTEND_DEPLOY_PATH }}/"

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e

          DEPLOY_DIR="${{ secrets.FRONTEND_DEPLOY_PATH }}"
          BACKUP_DIR="${{ secrets.FRONTEND_DEPLOY_PATH }}-backup"

          # Backup existing deployment
          if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR)" ]; then
            echo "Creating backup..."
            rm -rf "$BACKUP_DIR"
            cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
          fi

          # Extract new build
          echo "Extracting new build..."
          cd "$DEPLOY_DIR"
          tar -xzf dist.tar.gz

          # Verify deployment
          if [ ! -f "$DEPLOY_DIR/index.html" ]; then
            echo "❌ Deployment verification failed: index.html not found"
            # Restore backup if exists
            if [ -d "$BACKUP_DIR" ]; then
              echo "Restoring backup..."
              rm -rf "$DEPLOY_DIR"/*
              cp -r "$BACKUP_DIR"/* "$DEPLOY_DIR"/
            fi
            exit 1
          fi

          # Cleanup
          rm -f "$DEPLOY_DIR/dist.tar.gz"

          # Reload web server (uncomment based on your setup)
          # sudo systemctl reload nginx
          # or
          # sudo service nginx reload

          echo "✅ Frontend deployment successful!"
          EOF

      - name: Verify deployment
        run: |
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.SERVER_URL }}")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Frontend is accessible (HTTP $HTTP_CODE)"
          else
            echo "⚠️  Warning: Frontend returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Cleanup local SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Frontend deployment successful!"
          else
            echo "❌ Frontend deployment failed!"
          fi
